/***********************************************************************************************************************
 * @file 	RPLidar.c
 * @brief	RPLidar functions
 * @author	Leandro
 * @date	01/07/2020
 * @company
 *
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * INCLUDES
 **********************************************************************************************************************/

#include "RPLidar.h"

/***********************************************************************************************************************
 * COSNTANTS
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * MACROS
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * TYPES
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * GLOBALS VARIABLES
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * PUBLIC FUNCTIONS
 **********************************************************************************************************************/

/***********************************************************************************************************************
 * @brief Send command to RPLidar via uart
 *
 * @param duty      - duty cycle to set in percentage ex: 99.5%
 * @param channel   - channel to set duty cycle
 *
 * @return void
 *
 **********************************************************************************************************************/
uint32_t sendCommand(uint8_t cmd, const void *payload, size_t payloadsize) {
    rplidar_cmd_packet_t RPLidar_header;
    
    uint8_t checksum = 0;

    if (payloadsize && payload) {
        cmd |= RPLIDAR_CMDFLAG_HAS_PAYLOAD;
    }

    RPLidar_header.syncByte = RPLIDAR_CMD_SYNC_BYTE;
    RPLidar_header.cmd_flag = cmd;

    //uart_write_bytes(UART_NUM_1, (char *)RPLidar_header, 2);        // send header first

    if (cmd & RPLIDAR_CMDFLAG_HAS_PAYLOAD) {
        checksum ^= RPLIDAR_CMD_SYNC_BYTE;
        checksum ^= cmd;
        checksum ^= (payloadsize & 0xFF);

        for (size_t pos = 0; pos < payloadsize; ++pos) {        // calc checksum
            checksum ^= ((uint8_t *)payload)[pos];
        }

        uint8_t sizebyte = payloadsize;        // send size
        //uart_write_bytes(UART_NUM_1, &sizebyte, 1);

        //uart_write_bytes(UART_NUM_1, &payload, sizebyte);        // send payload

        //uart_write_bytes(UART_NUM_1, &checksum, 1);        // send checksum
    }

    return RESULT_OK;
}

/***********************************************************************************************************************
 * END OF FILE
 **********************************************************************************************************************/